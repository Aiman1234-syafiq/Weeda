{% extends "base.html" %}

{% block title %}Create New PR{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Create New Purchase Requisition</h1>
    <p class="page-description">Fill in the details below to create a new PR <strong>with quotation</strong></p>
</div>

<div class="card">
    <form method="POST" action="/pr/new" enctype="multipart/form-data" id="prForm">
        <!-- Hidden field untuk items -->
        <input type="hidden" name="items" id="itemsInput">
        
        <!-- Section 1: Basic Information -->
        <div class="form-section">
            <h3 class="form-section-title">1. Basic Information</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="requester_name">Requester Name *</label>
                    <input type="text" class="form-control" id="requester_name" 
                           name="requester_name" value="{{ session.name }}" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="department">Department *</label>
                    <select class="form-control" id="department" name="department" required>
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if dept == session.department.lower() %}selected{% endif %}>
                            {{ dept|upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="purpose">Purpose / Description *</label>
                <textarea class="form-control" id="purpose" name="purpose" 
                          rows="2" required placeholder="Describe what you need to purchase and why..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select class="form-control" id="priority" name="priority">
                        <option value="NORMAL">Normal</option>
                        <option value="URGENT">Urgent</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fiscal_year">Fiscal Year</label>
                    <input type="text" class="form-control" id="fiscal_year" 
                           name="fiscal_year" value="{{ fiscal_year }}" readonly>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Vendor Information -->
        <div class="form-section">
            <h3 class="form-section-title">2. Vendor Information</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="vendor_code">Vendor Code (Optional)</label>
                    <div class="input-with-button">
                        <input type="text" class="form-control" id="vendor_code" 
                               name="vendor_code" placeholder="V001, V002, etc.">
                        <button type="button" class="btn btn-secondary" id="searchVendorBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted">Leave blank if vendor is not registered</small>
                </div>
                
                <div class="form-group">
                    <label for="vendor_name">Vendor Name *</label>
                    <input type="text" class="form-control" id="vendor_name" 
                           name="vendor_name" required placeholder="Company or supplier name">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="vendor_contact">Contact Person</label>
                    <input type="text" class="form-control" id="vendor_contact" 
                           name="vendor_contact" placeholder="Name, phone, email">
                </div>
                
                <div class="form-group">
                    <label for="payment_terms">Payment Terms</label>
                    <select class="form-control" id="payment_terms" name="payment_terms">
                        <option value="NET30">NET 30</option>
                        <option value="NET45">NET 45</option>
                        <option value="NET60">NET 60</option>
                        <option value="CASH">Cash</option>
                        <option value="ADVANCE">Advance Payment</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Section 3: Budget Information -->
        <div class="form-section">
            <h3 class="form-section-title">3. Budget Information</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="budget_category">Budget Category</label>
                    <select class="form-control" id="budget_category" name="budget_category">
                        <option value="">No Budget Category (Out of Budget)</option>
                        {% for category in budget_categories %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Budget Status</label>
                    <div class="budget-status" id="budgetStatus">
                        <span class="badge badge-secondary">Select category to check budget</span>
                    </div>
                    <small class="form-text text-muted" id="budgetRemaining">-</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="currency">Currency</label>
                    <select class="form-control" id="currency" name="currency">
                        <option value="MYR" selected>Malaysian Ringgit (MYR)</option>
                        <option value="USD">US Dollar (USD)</option>
                        <option value="SGD">Singapore Dollar (SGD)</option>
                        <option value="EUR">Euro (EUR)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tax_amount">Tax Amount (MYR)</label>
                    <input type="number" class="form-control" id="tax_amount" 
                           name="tax_amount" value="0" min="0" step="0.01">
                </div>
            </div>
        </div>
        
        <!-- Section 4: Items -->
        <div class="form-section">
            <h3 class="form-section-title">4. Purchase Items</h3>
            <p class="form-section-subtitle">Add items to your purchase requisition</p>
            
            <!-- Items Table -->
            <div class="table-responsive">
                <table class="table" id="itemsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Description *</th>
                            <th>Quantity *</th>
                            <th>Unit *</th>
                            <th>Unit Price *</th>
                            <th>Total Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <!-- Items will be added here dynamically -->
                        <tr id="noItemsRow">
                            <td colspan="7" class="text-center text-muted py-4">
                                No items added yet. Click "Add Item" below to start.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" class="text-right"><strong>Subtotal:</strong></td>
                            <td><strong id="subtotal">0.00</strong></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="5" class="text-right">Tax:</td>
                            <td id="taxDisplay">0.00</td>
                            <td></td>
                        </tr>
                        <tr class="total-row">
                            <td colspan="5" class="text-right"><strong>Grand Total:</strong></td>
                            <td><strong id="grandTotal">0.00</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- Add Item Button -->
            <div class="text-center mb-4">
                <button type="button" class="btn btn-outline-primary" id="addItemBtn">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
            
            <!-- Item Form (Hidden by default) -->
            <div class="card" id="itemFormCard" style="display: none;">
                <div class="card-body">
                    <h4 class="card-title">Add/Edit Item</h4>
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="itemDescription">Description *</label>
                            <input type="text" class="form-control" id="itemDescription" 
                                   placeholder="Item description or name">
                        </div>
                        
                        <div class="form-group col-md-2">
                            <label for="itemQuantity">Quantity *</label>
                            <input type="number" class="form-control" id="itemQuantity" 
                                   value="1" min="1" step="1">
                        </div>
                        
                        <div class="form-group col-md-2">
                            <label for="itemUOM">Unit *</label>
                            <select class="form-control" id="itemUOM">
                                <option value="UNIT">UNIT</option>
                                <option value="PCS">PCS</option>
                                <option value="BOX">BOX</option>
                                <option value="SET">SET</option>
                                <option value="KG">KG</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="PAIR">PAIR</option>
                            </select>
                        </div>
                        
                        <div class="form-group col-md-2">
                            <label for="itemUnitPrice">Unit Price (MYR) *</label>
                            <input type="number" class="form-control" id="itemUnitPrice" 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-4">
                            <label for="itemCatalogNo">Catalog Number</label>
                            <input type="text" class="form-control" id="itemCatalogNo" 
                                   placeholder="Optional catalog number">
                        </div>
                        
                        <div class="form-group col-md-8">
                            <label for="itemSpecifications">Specifications</label>
                            <input type="text" class="form-control" id="itemSpecifications" 
                                   placeholder="Optional specifications or details">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemNotes">Notes</label>
                        <textarea class="form-control" id="itemNotes" 
                                  rows="2" placeholder="Optional notes about this item"></textarea>
                    </div>
                    
                    <div class="d-flex justify-between">
                        <button type="button" class="btn btn-secondary" id="cancelItemBtn">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="saveItemBtn">
                            Save Item
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 5: Quotation Upload -->
        <div class="form-section">
            <h3 class="form-section-title">5. Quotation Upload</h3>
            <p class="form-section-subtitle">
                <span class="text-danger"><strong>REQUIRED:</strong></span> 
                Upload quotation file from vendor
            </p>
            
            <div class="form-group">
                <label for="quotation">Quotation File *</label>
                <div class="file-upload-area">
                    <input type="file" class="form-control-file" id="quotation" 
                           name="quotation" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required>
                    <small class="form-text text-muted">
                        Allowed file types: PDF, JPG, PNG, DOC, DOCX (Max: 10MB)
                    </small>
                </div>
                <div id="filePreview" class="mt-2" style="display: none;">
                    <div class="file-preview-card">
                        <i class="fas fa-file-pdf"></i>
                        <span id="fileName">filename.pdf</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="removeFileBtn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Important:</strong> Without quotation file, procurement cannot create PO.
            </div>
        </div>
        
        <!-- Submit Buttons -->
        <div class="form-actions">
            <a href="/dashboard" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Submit PR with Quotation
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables
    let items = [];
    let editIndex = -1;
    const allowedExtensions = {{ allowed_extensions|tojson }};
    
    // Vendor search
    document.getElementById('searchVendorBtn').addEventListener('click', function() {
        const vendorCode = document.getElementById('vendor_code').value.trim();
        if (!vendorCode) {
            alert('Please enter vendor code');
            return;
        }
        
        fetch(`/api/vendors/${vendorCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('vendor_name').value = data.vendor.vendor_name || '';
                    document.getElementById('vendor_contact').value = [
                        data.vendor.contact_person,
                        data.vendor.contact_phone,
                        data.vendor.contact_email
                    ].filter(Boolean).join(' | ');
                    document.getElementById('payment_terms').value = data.vendor.payment_terms || 'NET30';
                } else {
                    alert('Vendor not found or inactive');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching vendor details');
            });
    });
    
    // Budget check
    document.getElementById('budget_category').addEventListener('change', function() {
        const category = this.value;
        const department = document.getElementById('department').value;
        const totalAmount = parseFloat(document.getElementById('grandTotal').textContent) || 0;
        
        if (!category || !department || totalAmount <= 0) return;
        
        // In production, you would call an API to check budget
        // For now, simulate budget check
        const statusElement = document.getElementById('budgetStatus');
        const remainingElement = document.getElementById('budgetRemaining');
        
        if (category) {
            statusElement.innerHTML = '<span class="badge badge-warning">Checking...</span>';
            
            // Simulate API call delay
            setTimeout(() => {
                // Random budget status for demo
                const isWithinBudget = Math.random() > 0.3;
                if (isWithinBudget) {
                    statusElement.innerHTML = '<span class="badge badge-success">Within Budget</span>';
                    remainingElement.textContent = `Estimated remaining: MYR ${(Math.random() * 50000 + 10000).toFixed(2)}`;
                } else {
                    statusElement.innerHTML = '<span class="badge badge-danger">Out of Budget</span>';
                    remainingElement.textContent = 'Will require budget exception approval';
                }
            }, 500);
        } else {
            statusElement.innerHTML = '<span class="badge badge-secondary">No Budget Category</span>';
            remainingElement.textContent = 'This PR will require budget exception approval';
        }
    });
    
    // File upload preview
    document.getElementById('quotation').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Check file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB');
            this.value = '';
            return;
        }
        
        // Check file extension
        const fileExt = file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExt)) {
            alert(`Invalid file type. Allowed: ${allowedExtensions.join(', ')}`);
            this.value = '';
            return;
        }
        
        // Show preview
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('filePreview').style.display = 'block';
    });
    
    document.getElementById('removeFileBtn').addEventListener('click', function() {
        document.getElementById('quotation').value = '';
        document.getElementById('filePreview').style.display = 'none';
    });
    
    // Items management
    document.getElementById('addItemBtn').addEventListener('click', function() {
        editIndex = -1;
        resetItemForm();
        document.getElementById('itemFormCard').style.display = 'block';
        document.getElementById('itemDescription').focus();
    });
    
    document.getElementById('cancelItemBtn').addEventListener('click', function() {
        document.getElementById('itemFormCard').style.display = 'none';
        resetItemForm();
    });
    
    document.getElementById('saveItemBtn').addEventListener('click', function() {
        if (!validateItemForm()) return;
        
        const item = {
            description: document.getElementById('itemDescription').value,
            quantity: parseInt(document.getElementById('itemQuantity').value),
            uom: document.getElementById('itemUOM').value,
            unit_price: parseFloat(document.getElementById('itemUnitPrice').value),
            catalog_number: document.getElementById('itemCatalogNo').value || null,
            specifications: document.getElementById('itemSpecifications').value || null,
            notes: document.getElementById('itemNotes').value || null
        };
        
        item.total_price = item.quantity * item.unit_price;
        
        if (editIndex === -1) {
            // Add new item
            items.push(item);
        } else {
            // Update existing item
            items[editIndex] = item;
        }
        
        updateItemsTable();
        document.getElementById('itemFormCard').style.display = 'none';
        resetItemForm();
        updateTotals();
    });
    
    function validateItemForm() {
        const description = document.getElementById('itemDescription').value.trim();
        const quantity = document.getElementById('itemQuantity').value;
        const unitPrice = document.getElementById('itemUnitPrice').value;
        
        if (!description) {
            alert('Item description is required');
            document.getElementById('itemDescription').focus();
            return false;
        }
        
        if (!quantity || quantity <= 0) {
            alert('Quantity must be greater than 0');
            document.getElementById('itemQuantity').focus();
            return false;
        }
        
        if (!unitPrice || unitPrice <= 0) {
            alert('Unit price must be greater than 0');
            document.getElementById('itemUnitPrice').focus();
            return false;
        }
        
        return true;
    }
    
    function resetItemForm() {
        document.getElementById('itemDescription').value = '';
        document.getElementById('itemQuantity').value = '1';
        document.getElementById('itemUOM').value = 'UNIT';
        document.getElementById('itemUnitPrice').value = '';
        document.getElementById('itemCatalogNo').value = '';
        document.getElementById('itemSpecifications').value = '';
        document.getElementById('itemNotes').value = '';
    }
    
    function updateItemsTable() {
        const tbody = document.getElementById('itemsTableBody');
        const noItemsRow = document.getElementById('noItemsRow');
        
        if (items.length === 0) {
            noItemsRow.style.display = '';
            return;
        }
        
        noItemsRow.style.display = 'none';
        tbody.innerHTML = '';
        
        items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.description}</td>
                <td>${item.quantity} ${item.uom}</td>
                <td>${item.unit_price.toFixed(2)}</td>
                <td>${item.total_price.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary edit-item" data-index="${index}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-item" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add event listeners for edit/delete buttons
        document.querySelectorAll('.edit-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                editItem(index);
            });
        });
        
        document.querySelectorAll('.delete-item').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                deleteItem(index);
            });
        });
    }
    
    function editItem(index) {
        editIndex = index;
        const item = items[index];
        
        document.getElementById('itemDescription').value = item.description;
        document.getElementById('itemQuantity').value = item.quantity;
        document.getElementById('itemUOM').value = item.uom;
        document.getElementById('itemUnitPrice').value = item.unit_price;
        document.getElementById('itemCatalogNo').value = item.catalog_number || '';
        document.getElementById('itemSpecifications').value = item.specifications || '';
        document.getElementById('itemNotes').value = item.notes || '';
        
        document.getElementById('itemFormCard').style.display = 'block';
        document.getElementById('itemDescription').focus();
    }
    
    function deleteItem(index) {
        if (confirm('Delete this item?')) {
            items.splice(index, 1);
            updateItemsTable();
            updateTotals();
        }
    }
    
    function updateTotals() {
        const subtotal = items.reduce((sum, item) => sum + item.total_price, 0);
        const taxAmount = parseFloat(document.getElementById('tax_amount').value) || 0;
        const grandTotal = subtotal + taxAmount;
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('taxDisplay').textContent = taxAmount.toFixed(2);
        document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        
        // Update budget check if category is selected
        const category = document.getElementById('budget_category').value;
        if (category) {
            document.getElementById('budget_category').dispatchEvent(new Event('change'));
        }
    }
    
    // Update totals when tax changes
    document.getElementById('tax_amount').addEventListener('input', updateTotals);
    
    // Form submission
    document.getElementById('prForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate items
        if (items.length === 0) {
            alert('Please add at least one item');
            return;
        }
        
        // Validate quotation file
        const quotationFile = document.getElementById('quotation').files[0];
        if (!quotationFile) {
            alert('Quotation file is required');
            return;
        }
        
        // Update hidden items field
        document.getElementById('itemsInput').value = JSON.stringify(items);
        
        // Submit form
        this.submit();
    });
    
    // Initialize
    updateTotals();
</script>

<style>
.form-section {
    margin-bottom: 2.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 1.5rem;
}

.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--primary);
    display: flex;
    align-items: center;
}

.form-section-title::before {
    content: '';
    display: inline-block;
    width: 4px;
    height: 18px;
    background-color: var(--primary);
    margin-right: 8px;
    border-radius: 2px;
}

.form-section-subtitle {
    font-size: 0.9rem;
    color: var(--secondary);
    margin-bottom: 1rem;
}

.input-with-button {
    display: flex;
    gap: 0.5rem;
}

.input-with-button .form-control {
    flex: 1;
}

.input-with-button .btn {
    white-space: nowrap;
}

.budget-status {
    padding: 0.5rem;
    background-color: var(--light);
    border-radius: 4px;
    min-height: 38px;
    display: flex;
    align-items: center;
}

.file-upload-area {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    transition: border-color 0.3s;
}

.file-upload-area:hover {
    border-color: var(--primary);
}

.file-preview-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background-color: var(--light);
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.file-preview-card i {
    font-size: 1.5rem;
    color: var(--danger);
}

.file-preview-card span {
    flex: 1;
    font-weight: 500;
}

.form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.table tfoot {
    background-color: var(--light);
}

.table tfoot .total-row {
    background-color: rgba(var(--primary-rgb), 0.1);
}

.badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.badge-success { background-color: var(--success); color: white; }
.badge-warning { background-color: var(--warning); color: white; }
.badge-danger { background-color: var(--danger); color: white; }
.badge-secondary { background-color: var(--secondary); color: white; }
</style>
{% endblock %}